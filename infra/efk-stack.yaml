# infra/efk-stack.yaml  (ONE card for the whole EFK stack)
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: efk-stack
  namespace: argocd
spec:
  project: default
  sources:
    # A) ECK Operator (installs all CRDs)
    - repoURL: https://helm.elastic.co
      chart: eck-operator
      targetRevision: 2.13.0
      helm:
        values: |
          installCRDs: true
      targetNamespace: elastic-system

    # B) Your CRs: Elasticsearch + Kibana (minimal resources)
    - repoURL: git@gitlab.com:yair_portfolio/argocd-gitops.git       # <-- CHANGE
      targetRevision: main                                # <-- CHANGE
      path: manifests/logging
      # no targetNamespace here because the CR files already specify `namespace: logging`

    # C) Fluent Bit to ship logs into ES
    - repoURL: git@gitlab.com:yair_portfolio/argocd-gitops.git
      chart: fluent-bit
      targetRevision: 0.46.9
      helm:
        values: |
          resources:
            requests: { cpu: 50m,  memory: 64Mi }
            limits:   { cpu: 100m, memory: 128Mi }
          daemonSetVolumes:
            - name: varlog
              hostPath: { path: /var/log }
            - name: varlibdockercontainers
              hostPath: { path: /var/lib/docker/containers }
          daemonSetVolumeMounts:
            - name: varlog
              mountPath: /var/log
            - name: varlibdockercontainers
              mountPath: /var/lib/docker/containers
              readOnly: true
          config:
            service: |
              [SERVICE]
                  Parsers_File parsers.conf
                  Grace 5
            inputs: |
              [INPUT]
                  Name              tail
                  Path              /var/log/containers/*.log
                  Parser            docker
                  Tag               kube.*
                  Refresh_Interval  5
                  Mem_Buf_Limit     20MB
                  Skip_Long_Lines   On
            filters: |
              [FILTER]
                  Name   kubernetes
                  Match  kube.*
                  Kube_Tag_Prefix kube.var.log.containers.
            outputs: |
              [OUTPUT]
                  Name  es
                  Match *
                  Host  elasticsearch-es-http.logging.svc
                  Port  9200
                  Logstash_Format On
                  Retry_Limit  False
                  Suppress_Type_Name On
      targetNamespace: logging

  destination:
    server: https://kubernetes.default.svc
    namespace: argocd   # app lives in argocd; resources go to their targetNamespace per source

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ApplyOutOfSyncOnly=true
      # lets ES/Kibana CRs pass dry-run while CRDs are being installed by ECK
      - SkipDryRunOnMissingResource=true
